{{template "layout" .}} {{define "content"}}
<div class="masthead mb-3">
  <div class="container-xxl bd-gutter">
    <div class="col-md-8 mx-auto text-center mt-5">
      <h1 class="mb-3 fw-semibold">
        <span class="d-inline-block blinking">👁</span> Panopticon <span class="d-inline-block blinking">👁</span>
      </h1>
    </div>
  </div>
</div>

<div class="container w-95 text-left">
  <div id="blockchain-metrics"></div>
</div>

<div class="container w-95 text-center border border-5 rounded pb-3">
  <h3 class="text-center">Protocol Dashboard</h3>
  <div id="dashboard"><div class="loader">Loading...</div></div>
</div>

<script type="module">
  import { DEPLOYMENT } from "/deployments/selected.js";
  import { GoGoPool, Blockchain } from "/js/gogopool.js";
  import { dashboardDef } from "/js/tabulator.js";
  let GGP, BC;

  async function initData() {
    GGP = new GoGoPool(DEPLOYMENT);
    BC = new Blockchain(DEPLOYMENT);

    await Promise.all([BC.fetchData(), GGP.fetchContracts(), GGP.fetchDashboardData()]);
    console.log("GGP Loaded", GGP);
  }

  await initData();

  BC.refreshDataLoop(() => (document.getElementById("blockchain-metrics").innerHTML = BC.statusLine()));

  const tableDashboard = new Tabulator("#dashboard", dashboardDef);
  GGP.refreshDataLoop(() => {
    tableDashboard.updateOrAddData(GGP.dashboardAsTabulatorData());
  });
</script>
{{ end }}
